<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .test-container {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 20px;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .output {
            white-space: pre-wrap;
            background-color: #f5f5f5;
            padding: 10px;
            border: 1px solid #ddd;
        }
        button {
            padding: 5px 10px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>Angry Parents: Xmas Edition - Tests</h1>
    
    <div class="test-container">
        <h2>Box2D Namespace Tests</h2>
        <div>
            <button onclick="testNamespace()">Test Box2D Namespace</button>
            <div id="namespaceOutput" class="output"></div>
        </div>
    </div>
    
    <div class="test-container">
        <h2>Box2D Functionality Tests</h2>
        <div id="box2dTests">
            <button onclick="testBox2DWorld()">Test Box2D World Creation</button>
            <button onclick="testBodyCreation()">Test Body Creation</button>
            <button onclick="testPhysicsStep()">Test Physics Step</button>
            <div id="box2dOutput" class="output"></div>
        </div>
    </div>

    <div class="test-container">
        <h2>Game Initialization Test</h2>
        <button onclick="testGameInit()">Test Game Initialization</button>
        <div id="gameInitOutput" class="output"></div>
    </div>

    <script src="libs/Box2D-fallback.js"></script>
    <script>
        // Utility functions
        function log(message, isError = false) {
            const outputDiv = document.getElementById('box2dOutput');
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'success';
            div.textContent = message;
            outputDiv.appendChild(div);
            console.log(message);
        }

        function logNamespace(message, isError = false) {
            const outputDiv = document.getElementById('namespaceOutput');
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'success';
            div.textContent = message;
            outputDiv.appendChild(div);
            console.log(message);
        }

        function logGameInit(message, isError = false) {
            const outputDiv = document.getElementById('gameInitOutput');
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'success';
            div.textContent = message;
            outputDiv.appendChild(div);
            console.log(message);
        }

        function clearLog(id) {
            document.getElementById(id).innerHTML = '';
        }

        // Test namespace
        function testNamespace() {
            clearLog('namespaceOutput');
            try {
                logNamespace('Testing Box2D namespace structure...');
                
                // Check main Box2D object
                if (typeof Box2D === 'undefined') {
                    throw new Error('Box2D is not defined');
                }
                logNamespace('Box2D object exists');
                
                // Check Common.Math namespace
                if (typeof Box2D.Common === 'undefined' || typeof Box2D.Common.Math === 'undefined') {
                    throw new Error('Box2D.Common.Math namespace is missing');
                }
                logNamespace('Box2D.Common.Math namespace exists');
                
                // Check b2Vec2 in both locations
                if (typeof Box2D.Common.Math.b2Vec2 !== 'function') {
                    throw new Error('Box2D.Common.Math.b2Vec2 is missing');
                }
                logNamespace('Box2D.Common.Math.b2Vec2 exists');
                
                if (typeof Box2D.b2Vec2 !== 'function') {
                    throw new Error('Box2D.b2Vec2 (top-level) is missing');
                }
                logNamespace('Box2D.b2Vec2 (top-level) exists');
                
                // Check Collision.Shapes
                if (typeof Box2D.Collision === 'undefined' || typeof Box2D.Collision.Shapes === 'undefined') {
                    throw new Error('Box2D.Collision.Shapes namespace is missing');
                }
                logNamespace('Box2D.Collision.Shapes namespace exists');
                
                // Check Dynamics
                if (typeof Box2D.Dynamics === 'undefined') {
                    throw new Error('Box2D.Dynamics namespace is missing');
                }
                logNamespace('Box2D.Dynamics namespace exists');
                
                // Test vector operations
                const vec1 = new Box2D.Common.Math.b2Vec2(3, 4);
                const len = vec1.Length();
                if (Math.abs(len - 5) > 0.001) {
                    throw new Error(`Vector length incorrect: expected 5, got ${len}`);
                }
                logNamespace('Vector operations work correctly');
                
                logNamespace('All namespace tests passed!');
            } catch (error) {
                logNamespace(`Test failed: ${error.message}`, true);
            }
        }

        // Test functions
        function testBox2DWorld() {
            clearLog('box2dOutput');
            try {
                log('Testing Box2D world creation...');
                
                // Check if Box2D is available
                if (typeof Box2D === 'undefined') {
                    throw new Error('Box2D is not defined');
                }
                
                log('Box2D object exists');
                
                // Try to create a world
                const gravity = new Box2D.Common.Math.b2Vec2(0, 10);
                const world = new Box2D.Dynamics.b2World(gravity);
                
                log('World created successfully');
                
                // Test GetBodyList
                const bodyList = world.GetBodyList();
                log(`GetBodyList returns: ${bodyList === null ? 'null (expected for empty world)' : 'not null (unexpected)'}`);
                
                // Test Step method
                try {
                    world.Step(1/60, 8, 3);
                    log('Step method executed successfully');
                } catch (error) {
                    log(`Error in Step method: ${error.message}`, true);
                }
                
            } catch (error) {
                log(`Test failed: ${error.message}`, true);
            }
        }

        function testBodyCreation() {
            clearLog('box2dOutput');
            try {
                log('Testing body creation...');
                
                const gravity = new Box2D.Common.Math.b2Vec2(0, 10);
                const world = new Box2D.Dynamics.b2World(gravity);
                
                // Create a body definition
                const bodyDef = new Box2D.Dynamics.b2BodyDef();
                bodyDef.type = Box2D.Dynamics.b2Body.b2_dynamicBody;
                bodyDef.position.Set(5, 5);
                
                // Create the body
                const body = world.CreateBody(bodyDef);
                log('Body created successfully');
                
                // Create a fixture (shape)
                const fixtureDef = new Box2D.Dynamics.b2FixtureDef();
                const shape = new Box2D.Collision.Shapes.b2CircleShape(1.0);
                fixtureDef.shape = shape;
                fixtureDef.density = 1.0;
                fixtureDef.friction = 0.3;
                fixtureDef.restitution = 0.5;
                
                // Add fixture to body
                const fixture = body.CreateFixture(fixtureDef);
                log('Fixture created successfully');
                
                // Test GetWorldCenter
                const center = body.GetWorldCenter();
                log(`Body center: (${center.x}, ${center.y})`);
                
                // Test ApplyLinearImpulse
                const impulse = new Box2D.Common.Math.b2Vec2(10, -5);
                try {
                    body.ApplyLinearImpulse(impulse, center);
                    log('ApplyLinearImpulse executed successfully');
                } catch (error) {
                    log(`Error in ApplyLinearImpulse: ${error.message}`, true);
                }
                
                // Test GetLinearVelocity
                const velocity = body.GetLinearVelocity();
                log(`Body velocity: (${velocity.x}, ${velocity.y})`);
                
            } catch (error) {
                log(`Test failed: ${error.message}`, true);
            }
        }

        function testPhysicsStep() {
            clearLog('box2dOutput');
            try {
                log('Testing physics simulation...');
                
                const gravity = new Box2D.Common.Math.b2Vec2(0, 10);
                const world = new Box2D.Dynamics.b2World(gravity);
                
                // Create ground
                const groundDef = new Box2D.Dynamics.b2BodyDef();
                groundDef.position.Set(5, 10);
                const ground = world.CreateBody(groundDef);
                
                const groundShape = new Box2D.Collision.Shapes.b2PolygonShape();
                groundShape.SetAsBox(5, 0.5);
                ground.CreateFixture2(groundShape, 0);
                log('Ground created successfully');
                
                // Create falling box
                const boxDef = new Box2D.Dynamics.b2BodyDef();
                boxDef.type = Box2D.Dynamics.b2Body.b2_dynamicBody;
                boxDef.position.Set(5, 2);
                const box = world.CreateBody(boxDef);
                
                const boxShape = new Box2D.Collision.Shapes.b2PolygonShape();
                boxShape.SetAsBox(0.5, 0.5);
                const fixtureDef = new Box2D.Dynamics.b2FixtureDef();
                fixtureDef.shape = boxShape;
                fixtureDef.density = 1.0;
                fixtureDef.friction = 0.3;
                fixtureDef.restitution = 0.5;
                box.CreateFixture(fixtureDef);
                log('Box created successfully');
                
                // Run simulation
                log('Running simulation for 60 steps...');
                for (let i = 0; i < 60; i++) {
                    world.Step(1/60, 8, 3);
                    if (i % 10 === 0) {
                        const pos = box.GetPosition();
                        log(`Box position at step ${i}: (${pos.x.toFixed(2)}, ${pos.y.toFixed(2)})`);
                    }
                }
                
                log('Simulation completed');
                
            } catch (error) {
                log(`Test failed: ${error.message}`, true);
            }
        }

        function testGameInit() {
            clearLog('gameInitOutput');
            try {
                logGameInit('Loading game scripts...');
                
                // Load required scripts
                const scripts = [
                    'js/utility.js',
                    'js/physics.js',
                    'js/game.js',
                    'js/main.js'
                ];
                
                let scriptsLoaded = 0;
                
                scripts.forEach(src => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = () => {
                        scriptsLoaded++;
                        logGameInit(`Loaded: ${src}`);
                        
                        if (scriptsLoaded === scripts.length) {
                            logGameInit('All scripts loaded, now initializing game...');
                            
                            // Try to initialize the game's physics
                            try {
                                if (typeof GamePhysics !== 'undefined') {
                                    const physics = new GamePhysics();
                                    physics.init().then(() => {
                                        logGameInit('Physics engine initialized successfully');
                                        
                                        // Try to create a simple physics body
                                        try {
                                            const bodyDef = new physics.b2BodyDef();
                                            bodyDef.type = physics.b2Body.b2_dynamicBody;
                                            bodyDef.position.Set(5, 5);
                                            
                                            const world = physics.world;
                                            if (world) {
                                                const body = world.CreateBody(bodyDef);
                                                if (body) {
                                                    logGameInit('Successfully created a physics body');
                                                } else {
                                                    logGameInit('Failed to create physics body', true);
                                                }
                                            } else {
                                                logGameInit('Physics world not created', true);
                                            }
                                        } catch (error) {
                                            logGameInit(`Error creating physics body: ${error.message}`, true);
                                        }
                                    }).catch(err => {
                                        logGameInit(`Physics initialization failed: ${err.message}`, true);
                                    });
                                } else {
                                    logGameInit('GamePhysics not found in scope', true);
                                }
                                
                            } catch (error) {
                                logGameInit(`Error initializing physics: ${error.message}`, true);
                            }
                        }
                    };
                    script.onerror = () => {
                        logGameInit(`Failed to load: ${src}`, true);
                    };
                    document.body.appendChild(script);
                });
                
            } catch (error) {
                logGameInit(`Test failed: ${error.message}`, true);
            }
        }
        
        // Run namespace test automatically
        window.addEventListener('load', testNamespace);
    </script>
</body>
</html>
